"""
æ•°æ®å¤„ç†å™¨æ¨¡å—

è¿™ä¸ªæ¨¡å—æä¾›äº†æ–‡æœ¬æ•°æ®å¤„ç†çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸»è¦ç”¨äºï¼š
1. æ–‡æœ¬éªŒè¯ï¼šæ£€æŸ¥è¾“å…¥æ–‡æœ¬çš„æœ‰æ•ˆæ€§
2. æ ‡è®°æ·»åŠ ï¼šä¸ºæ–‡æœ¬æ·»åŠ å¤„ç†æ ‡è¯†å’Œæ—¶é—´æˆ³
3. æ ¼å¼åŒ–å¤„ç†ï¼šç»Ÿä¸€æ–‡æœ¬æ ¼å¼å’Œç»“æ„

æŠ€æœ¯ç‰¹ç‚¹ï¼š
- æ”¯æŒè‡ªå®šä¹‰å¤„ç†æ ‡è®°
- å¯é€‰çš„æ—¶é—´æˆ³åŠŸèƒ½
- å®Œæ•´çš„è¾“å…¥éªŒè¯
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- ç®€æ´çš„APIè®¾è®¡

ä½¿ç”¨åœºæ™¯ï¼š
- AIå¤„ç†ç»“æœæ ‡è®°
- æ–‡æœ¬é¢„å¤„ç†
- æ•°æ®æ ¼å¼åŒ–
- å¤„ç†çŠ¶æ€è·Ÿè¸ª

ä½œè€…ï¼šMCPå›¾åƒè¯†åˆ«ç³»ç»Ÿ
ç‰ˆæœ¬ï¼š1.0.0
"""

import logging                    # æ—¥å¿—è®°å½•
from datetime import datetime     # æ—¶é—´æˆ³ç”Ÿæˆ
from typing import Optional       # ç±»å‹æ³¨è§£

# ==================== æ—¥å¿—é…ç½® ====================
# ä½¿ç”¨ç°æœ‰çš„æ—¥å¿—é…ç½®ï¼Œç¡®ä¿ä¸æ•´ä¸ªç³»ç»Ÿçš„æ—¥å¿—ç­–ç•¥ä¸€è‡´
logger = logging.getLogger(__name__)

class DataProcessor:
    """
    æ•°æ®å¤„ç†å™¨

    è¿™ä¸ªç±»æä¾›äº†æ–‡æœ¬æ•°æ®å¤„ç†çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬æ–‡æœ¬éªŒè¯ã€
    æ ‡è®°æ·»åŠ å’Œæ ¼å¼åŒ–å¤„ç†ã€‚è®¾è®¡ç®€æ´æ˜“ç”¨ï¼Œæ”¯æŒæ‰©å±•ã€‚

    ä¸»è¦åŠŸèƒ½ï¼š
    - æ–‡æœ¬æœ‰æ•ˆæ€§éªŒè¯
    - æ·»åŠ å¤„ç†æ ‡è¯†å’Œæ—¶é—´æˆ³
    - æ”¯æŒè‡ªå®šä¹‰æ ‡è®°æ ¼å¼
    - æä¾›è¯¦ç»†çš„å¤„ç†æ—¥å¿—
    """

    def __init__(self):
        """
        åˆå§‹åŒ–æ•°æ®å¤„ç†å™¨

        åˆ›å»ºå¤„ç†å™¨å®ä¾‹ï¼Œè®¾ç½®é»˜è®¤é…ç½®ã€‚
        å½“å‰ç‰ˆæœ¬ä¸éœ€è¦ç‰¹æ®Šé…ç½®ï¼Œä½†ä¸ºæœªæ¥æ‰©å±•é¢„ç•™æ¥å£ã€‚
        """
        logger.info("ğŸ”§ æ•°æ®å¤„ç†å™¨åˆå§‹åŒ–å®Œæˆ")
    
    def add_processed_marker(self, original_text: str, add_timestamp: bool = True) -> str:
        """
        ä¸ºåŸå§‹æ–‡æœ¬æ·»åŠ å¤„ç†æ ‡è¯†

        è¿™ä¸ªæ–¹æ³•ä¸ºè¾“å…¥çš„æ–‡æœ¬æ·»åŠ å¤„ç†æ ‡è®°ï¼Œç”¨äºæ ‡è¯†æ–‡æœ¬å·²ç»è¢«ç³»ç»Ÿå¤„ç†è¿‡ã€‚
        æ”¯æŒå¯é€‰çš„æ—¶é—´æˆ³åŠŸèƒ½ï¼Œä¾¿äºè·Ÿè¸ªå¤„ç†æ—¶é—´ã€‚

        å¤„ç†é€»è¾‘ï¼š
        1. éªŒè¯è¾“å…¥æ–‡æœ¬æ˜¯å¦ä¸ºç©º
        2. æ ¹æ®å‚æ•°å†³å®šæ˜¯å¦æ·»åŠ æ—¶é—´æˆ³
        3. æ„é€ å¸¦æ ‡è¯†çš„æ–‡æœ¬
        4. è®°å½•å¤„ç†æ—¥å¿—

        Args:
            original_text: éœ€è¦æ·»åŠ æ ‡è¯†çš„åŸå§‹æ–‡æœ¬
            add_timestamp: æ˜¯å¦åœ¨æ ‡è¯†ä¸­åŒ…å«æ—¶é—´æˆ³ï¼Œé»˜è®¤ä¸ºTrue

        Returns:
            str: æ·»åŠ äº†å¤„ç†æ ‡è¯†çš„æ–‡æœ¬

        Examples:
            >>> processor = DataProcessor()
            >>> processor.add_processed_marker("æµ‹è¯•æ–‡æœ¬", True)
            "[å·²å¤„ç†-2025-01-15 10:30:45] æµ‹è¯•æ–‡æœ¬"
            >>> processor.add_processed_marker("æµ‹è¯•æ–‡æœ¬", False)
            "[å·²å¤„ç†] æµ‹è¯•æ–‡æœ¬"
        """
        # ==================== è¾“å…¥éªŒè¯ ====================
        if not original_text:
            logger.warning("âš ï¸ è¾“å…¥æ–‡æœ¬ä¸ºç©ºï¼Œè¿”å›é»˜è®¤æ ‡è¯†")
            return "[å·²å¤„ç†] (ç©ºå†…å®¹)"

        logger.info(f"ğŸ”„ å¼€å§‹ä¸ºæ–‡æœ¬æ·»åŠ å¤„ç†æ ‡è¯†")
        logger.info(f"ğŸ“ åŸå§‹æ–‡æœ¬: {original_text[:100]}...")  # åªæ˜¾ç¤ºå‰100å­—ç¬¦

        # ==================== æ„é€ å¤„ç†æ ‡è¯† ====================
        if add_timestamp:
            # ç”Ÿæˆå½“å‰æ—¶é—´æˆ³ï¼Œæ ¼å¼ï¼šYYYY-MM-DD HH:MM:SS
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            processed_text = f"[å·²å¤„ç†-{timestamp}] {original_text}"
            logger.info(f"â° æ·»åŠ æ—¶é—´æˆ³: {timestamp}")
        else:
            # ä¸æ·»åŠ æ—¶é—´æˆ³ï¼Œä½¿ç”¨ç®€å•æ ‡è¯†
            processed_text = f"[å·²å¤„ç†] {original_text}"
            logger.info("ğŸ·ï¸ ä½¿ç”¨ç®€å•æ ‡è¯†")

        logger.info(f"âœ… å¤„ç†å®Œæˆï¼Œç»“æœé•¿åº¦: {len(processed_text)} å­—ç¬¦")
        logger.info(f"ğŸ“„ å¤„ç†ç»“æœé¢„è§ˆ: {processed_text[:100]}...")

        return processed_text
    
    def validate_text(self, text: str) -> bool:
        """
        éªŒè¯æ–‡æœ¬æ˜¯å¦æœ‰æ•ˆ

        è¿™ä¸ªæ–¹æ³•æ£€æŸ¥è¾“å…¥æ–‡æœ¬çš„æœ‰æ•ˆæ€§ï¼Œç¡®ä¿æ–‡æœ¬ä¸ä¸ºç©ºä¸”åŒ…å«æœ‰æ„ä¹‰çš„å†…å®¹ã€‚
        ç”¨äºåœ¨å¤„ç†å‰éªŒè¯è¾“å…¥ï¼Œé¿å…å¤„ç†æ— æ•ˆæ•°æ®ã€‚

        éªŒè¯è§„åˆ™ï¼š
        1. æ–‡æœ¬ä¸èƒ½ä¸ºNone
        2. æ–‡æœ¬ä¸èƒ½ä¸ºç©ºå­—ç¬¦ä¸²
        3. æ–‡æœ¬å»é™¤ç©ºç™½å­—ç¬¦åä¸èƒ½ä¸ºç©º

        Args:
            text: éœ€è¦éªŒè¯çš„æ–‡æœ¬å­—ç¬¦ä¸²

        Returns:
            bool: å¦‚æœæ–‡æœ¬æœ‰æ•ˆè¿”å›Trueï¼Œå¦åˆ™è¿”å›False

        Examples:
            >>> processor = DataProcessor()
            >>> processor.validate_text("æœ‰æ•ˆæ–‡æœ¬")
            True
            >>> processor.validate_text("")
            False
            >>> processor.validate_text("   ")
            False
            >>> processor.validate_text(None)
            False
        """
        logger.info(f"ğŸ” å¼€å§‹éªŒè¯æ–‡æœ¬æœ‰æ•ˆæ€§")

        # ==================== æ–‡æœ¬æœ‰æ•ˆæ€§æ£€æŸ¥ ====================
        if not text or not text.strip():
            # æ–‡æœ¬ä¸ºç©ºã€Noneæˆ–åªåŒ…å«ç©ºç™½å­—ç¬¦
            logger.warning("âŒ æ–‡æœ¬éªŒè¯å¤±è´¥: æ–‡æœ¬ä¸ºç©ºæˆ–åªåŒ…å«ç©ºç™½å­—ç¬¦")
            logger.warning(f"ğŸ“ è¾“å…¥å†…å®¹: '{text}'")
            return False

        # æ–‡æœ¬éªŒè¯é€šè¿‡
        logger.info("âœ… æ–‡æœ¬éªŒè¯é€šè¿‡")
        logger.info(f"ğŸ“ æ–‡æœ¬é•¿åº¦: {len(text)} å­—ç¬¦")
        logger.info(f"ğŸ“„ æ–‡æœ¬é¢„è§ˆ: {text[:50]}...")  # æ˜¾ç¤ºå‰50å­—ç¬¦

        return True
